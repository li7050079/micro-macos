# 架构设计文档

## 1. 系统架构概述

本项目采用微前端架构，基于 Vue 3 + Pinia + micro-app 构建，模拟 macOS 风格的桌面应用环境。系统由主应用和多个子应用组成，主应用负责整体布局、状态管理和子应用的生命周期管理，子应用负责具体业务功能的实现。

### 1.1 核心技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue | 3.x | 主应用框架 |
| Pinia | 2.x | 状态管理 |
| micro-app | 1.x | 微前端框架 |
| JavaScript | ES6+ | 开发语言 |
| CSS3 | - | 样式设计 |
| Vite | 4.x | 构建工具 |

### 1.2 系统分层

- **表现层**：主应用的 UI 组件，包括桌面、窗口、Dock 栏等
- **状态层**：Pinia 状态管理，包括配置、窗口、桌面、子应用等状态
- **微前端层**：micro-app 微前端框架，负责子应用的加载和管理
- **服务层**：应用管理服务、事件总线、工具函数等服务

## 2. 主应用架构

### 2.1 目录结构

```
src/
├── App.vue                 # 主应用根组件
├── main.js                # 主应用入口
├── components/            # 通用组件
│   ├── DesktopIcon.vue     # 桌面图标组件
│   ├── Window.vue          # 窗口组件
│   ├── Dock.vue            # Dock 栏组件
│   ├── SystemMenu.vue      # 系统菜单组件
│   ├── FileSystem.vue      # 文件系统组件
│   └── ...                 # 其他组件
├── micro-app/             # 微前端相关
│   ├── micro-app-config.js # micro-app 配置
│   └── event-bus.js        # 事件总线
├── services/              # 服务
│   └── appManagerService.js # 应用管理服务
├── stores/                # Pinia 状态管理
│   ├── configStore.js     # 配置状态
│   ├── windowStore.js     # 窗口状态
│   ├── desktopStore.js    # 桌面状态
│   └── microAppStore.js   # 子应用状态
├── styles/                # 样式文件
│   └── main.css           # 主样式文件
├── utils/                 # 工具函数
│   └── dragManager.js     # 拖拽管理工具
└── assets/                # 静态资源
    └── icons/             # 图标资源
```

### 2.2 核心模块

#### 2.2.1 状态管理

- **configStore**：管理系统配置，包括主题、桌面、Dock 等设置
- **windowStore**：管理窗口状态，包括窗口的创建、激活、最小化、最大化等操作
- **desktopStore**：管理桌面状态，包括多桌面、文件系统、通知中心等
- **microAppStore**：管理子应用状态，包括子应用的加载、卸载、通信等

#### 2.2.2 微前端管理

- **micro-app 配置**：配置子应用的注册、加载策略等
- **事件总线**：实现主应用与子应用、子应用之间的通信
- **子应用生命周期**：管理子应用的挂载、卸载等生命周期
- **应用管理服务**：管理应用配置、桌面应用和应用菜单

#### 2.2.3 UI 组件

- **桌面**：模拟 macOS 桌面环境，包括图标、背景等
- **窗口**：模拟 macOS 窗口，支持拖拽、缩放、最小化等操作
- **Dock 栏**：模拟 macOS Dock 栏，显示常用应用和系统功能
- **系统菜单**：模拟 macOS 系统菜单，提供系统级操作
- **通知中心**：模拟 macOS 通知中心，显示系统和应用通知
- **文件系统**：模拟文件系统操作
- **配置面板**：系统配置面板

## 3. 子应用架构

### 3.1 子应用规范

- **技术栈**：支持 Vue 3、React、Angular 等多种技术栈
- **生命周期**：实现 micro-app 要求的生命周期钩子
- **通信机制**：通过事件总线与主应用和其他子应用通信
- **资源管理**：独立管理自身资源，避免与其他应用冲突
- **路由支持**：支持动态路由参数传递，实现主应用直接访问子应用业务功能

### 3.2 子应用接入流程

1. **注册子应用**：在主应用的应用管理服务中注册子应用配置
2. **实现生命周期**：子应用实现 mount、unmount 等生命周期钩子
3. **配置构建**：修改子应用构建配置，支持微前端环境
4. **部署子应用**：部署子应用到指定地址
5. **启动子应用**：主应用通过窗口管理启动子应用

### 3.3 示例子应用

- **Vue 3 子应用**：基于 Vue 3 + Vue Router 构建
- **React 子应用**：基于 React + React Router 构建
- **React UMIJS 子应用**：基于 React + UMIJS 构建
- **Angular 子应用**：基于 Angular + Angular Router 构建

## 4. 通信机制

### 4.1 主应用与子应用通信

- **props 传递**：主应用通过 props 向子应用传递数据，包括路由信息
- **事件总线**：通过 event-bus.js 实现事件发布订阅
- **全局 window 对象**：通过全局 window 对象共享数据和方法

### 4.2 子应用之间通信

- **事件总线**：子应用通过事件总线进行通信
- **localStorage**：通过本地存储进行数据持久化

## 5. 状态管理

### 5.1 状态设计原则

- **单一数据源**：所有状态集中管理，避免分散
- **响应式**：使用 Pinia 的响应式系统，确保状态变更能及时反映到 UI
- **模块化**：按功能模块划分状态，提高可维护性
- **持久化**：关键状态支持本地存储持久化

### 5.2 状态同步机制

- **配置同步**：主题、桌面背景等配置在多个模块间同步
- **多桌面同步**：不同桌面的状态独立管理，避免相互影响
- **窗口状态同步**：窗口状态在不同操作间同步
- **应用状态同步**：应用使用频率、打开状态等在不同模块间同步

## 6. 性能优化策略

### 6.1 加载优化

- **预加载**：根据用户习惯预加载常用子应用
- **懒加载**：非关键子应用采用懒加载策略
- **资源缓存**：优化子应用资源的缓存策略
- **代码分割**：合理分割子应用代码，减少初始加载时间

### 6.2 运行时优化

- **内存管理**：监控和优化内存使用，避免内存泄漏
- **CPU 优化**：减少不必要的计算和渲染
- **网络优化**：优化子应用的网络请求，减少延迟
- **渲染优化**：使用虚拟列表等技术优化大量数据的渲染
- **动画优化**：使用 requestAnimationFrame 优化动画效果

## 7. 安全机制

### 7.1 子应用隔离

- **沙箱隔离**：使用 micro-app 的沙箱机制隔离子应用
- **样式隔离**：使用 micro-app 的严格样式隔离
- **JS 隔离**：使用沙箱隔离 JavaScript 执行环境

### 7.2 权限控制

- **子应用权限**：限制子应用的访问范围
- **操作权限**：限制子应用的操作权限
- **资源权限**：限制子应用的资源访问权限

## 8. 扩展性设计

### 8.1 插件系统

- **插件注册**：支持插件的注册和管理
- **插件生命周期**：插件的加载、卸载等生命周期
- **插件 API**：为插件提供统一的 API

### 8.2 主题系统

- **主题定义**：支持明暗主题和自定义主题
- **主题切换**：实现主题的动态切换
- **主题变量**：使用 CSS 变量实现主题样式

### 8.3 国际化

- **语言包**：支持多语言包
- **动态切换**：实现语言的动态切换
- **国际化 API**：为子应用提供国际化 API

## 9. 部署架构

### 9.1 部署方案

- **主应用部署**：部署到主域名
- **子应用部署**：部署到子域名或路径
- **CDN 加速**：使用 CDN 加速静态资源

### 9.2 版本管理

- **主应用版本**：独立版本管理
- **子应用版本**：独立版本管理，支持灰度发布
- **版本兼容**：确保不同版本的主应用和子应用兼容

## 10. 监控与日志

### 10.1 监控系统

- **性能监控**：监控应用性能指标
- **错误监控**：监控应用错误
- **用户行为**：监控用户行为

### 10.2 日志系统

- **前端日志**：前端错误和操作日志
- **后端日志**：后端 API 调用日志
- **日志分析**：日志分析和告警

## 11. 微前端架构优势

### 11.1 技术栈无关

- 支持 Vue、React、Angular 等多种技术栈
- 子应用可以使用不同的技术栈独立开发

### 11.2 独立部署

- 子应用可以独立构建和部署
- 主应用和子应用版本独立管理

### 11.3 性能优化

- 基于 micro-app 的轻量级微前端方案
- 支持子应用预加载和懒加载
- 平滑的子应用切换体验

### 11.4 开发效率

- 子应用可以独立开发和测试
- 团队可以并行开发不同的子应用
- 代码维护性和可读性更高

## 12. 总结

本架构设计文档描述了项目的整体架构、核心模块、通信机制、状态管理、性能优化、安全机制、扩展性设计、部署架构和监控日志等方面。通过这种架构设计，系统具有良好的可扩展性、可维护性和性能表现，能够满足复杂业务场景的需求。

架构设计遵循了微前端的最佳实践，通过 micro-app 实现了子应用的隔离和管理，通过 Pinia 实现了状态的集中管理，通过 Vue 3 实现了现代化的前端开发体验。同时，系统模拟了 macOS 的桌面环境，提供了直观、友好的用户界面。

在后续的开发中，我们将按照这个架构设计，不断完善和优化系统，为用户提供更好的体验。